/*
 * sync-wrangler
 * https://github.com/jchris/sync-wrangler
 *
 * Copyright (c) 2013 Chris Anderson
 * Licensed under the Apache license.
 */

var sw = require("coax");

sw.extend("channels", function(channels, opts) {
  var self = this;
  var opts = opts || {};

  opts.filter = "sync_gateway/bychannel";
  opts.feed = "continuous"
  opts.channels = channels.join(',')

  // console.log(self.pax.toString())
  var changes = self(['_changes', opts], function(err, ok){
    console.log("_changes", err, ok)
  })
  changes.on("data", function(data) {
    try{
      var json = JSON.parse(data.toString())
      changes.emit("json", json)
    }catch(e){
      console.log("not json", data.toString())
    }

  })
  changes.on("json", function(json) {
    self([json.id], function(err, doc){
      if (!err) {
        changes.emit("doc", doc, json)
      }
    })
  })

  return changes;
});

module.exports = sw;

// function setupTempAdmin(authHost, cb) {
//   var channelPass = Math.random().toString(12).slice(2)
//   coax.put(authHost+"/channelServer", {
//     name: "channelServer", password : channelPass,
//     admin_channels : ["*"]
//   }, function(err, ok) {
//     if (err) {
//       console.log("couldn't turn on channelServer access", err);
//       cb(err)
//     } else {
//       var adminCreds = 'channelServer:'+channelPass;
//       cb(false, adminCreds);
//     }
//   });
// }

